"""!
@brief uses malduck (https://github.com/CERT-Polska/malduck) and
mwcfg (https://github.com/c3rb3ru5d3d53c/mwcfg/) to extract configurations from files.
@details mwcfg is a submodule located "./scripts/extractors/MalwareConfigExtractor"
if a new parser is not available, update the submodule.
"""
from deject.plugins import Deject
import hashlib
import pkgutil
import magic
from malduck.extractor import ExtractManager, ExtractorModules

@Deject.plugin
def extract_config_worker():
    """Try to extract configs from known Malware Families, such as ASyncRAT and Dridex"""
    filename = Deject.file_path
    with open(filename, "rb") as f:
        data = f.read()
    md5 = hashlib.md5(data).hexdigest()
    sha1 = hashlib.sha1(data).hexdigest()
    sha256 = hashlib.sha256(data).hexdigest()
    modules = ExtractorModules("./scripts/extractors/MalwareConfigExtractor")
    ext = ExtractManager(modules=modules)
    ext.push_file(filename)

    result = {
        'type': magic.from_buffer(data),
        'mime': magic.from_buffer(data, mime=True),
        'md5': md5,
        'sha1': sha1,
        'sha256': sha256,
        'configs': ext.config
    }
    print(result)

def get_modules():
    result = ''
    modules = [name for _, name, _ in pkgutil.iter_modules(["./scripts/extractors/MalwareConfigExtractor"])]
    for module in modules:
        result = result + '<p>' + module + '<p>\n'
    return result

def extract_malware_config(cfg, hash, filepath):
    result = extract_config_worker(filepath)
    print(result)
    return False

def help():
    print("""
Malware Config Extract plugin
SYNOPSIS <filename>
This plugin uses MalDuck and MWCFG to check for malware configurations in a file.
There are no additional arguments to this plugin.
""")